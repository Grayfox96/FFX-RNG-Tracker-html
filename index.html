<!doctype html>
<html>
	<head>
		<style type='text/css'>
			.container {
				display: grid;
				grid-template-columns: 1fr 1fr 1fr 100fr;
				column-gap: 4px;
			}
		</style>
		<script>
			const raw_rng_file = 'https://gist.githubusercontent.com/Grayfox96/468e7a4ba63281208e07b476d45ccf3f/raw/d16cd4e02d08c7eda63ff191cc75b9923cc55ce4/ffxhd-raw-encounter-values.csv'
			const formations_file = 'https://gist.githubusercontent.com/Grayfox96/fe50cabfd264caeefdabe34507b86bce/raw/38a0aa30f58b6746bf4bcceefd7872d168095b34/ffxhd-formations.csv'
			var current_seed = []
			var formations_array = []
			async function get_csv_file(file) {
				response = await fetch(file);
				text = await response.text()
				return text
			}
			function csv_to_array(csv_text, delimiter = ',') {
				let array = []
				let rows = csv_text.split('\n');
				for (let i in rows) {
					array.push(rows[i].split(','));
				}
				return array
			}
			function get_formations_array(formations_text, delimiter=',') {
				let array = []
				let rows = formations_text.split('\n');
				for (let i in rows) {
					let row = rows[i].split(',')
					for (let j in row) {
						if (j == 0) {
							array[row[0]] = []
						} else {
							array[row[0]].push(row[j])
						}
					}
				}
				return array
			}
			function get_current_seed(rng_array){
				damage_rolls = []
				let form = document.forms.damage_rolls_form
				damage_rolls['auron'] = [form.elements[0].value, form.elements[2].value, form.elements[4].value]
				damage_rolls['tidus'] = [form.elements[1].value, form.elements[3].value, form.elements[5].value]
				for (let i = 0; i < 3; i++) {
					if (damage_rolls['auron'][i] > 294) {
						damage_rolls['auron'][i] = damage_rolls['auron'][i] / 2
					}
					if (damage_rolls['tidus'][i] > 141) {
						damage_rolls['tidus'][i] = damage_rolls['tidus'][i] / 2
					}
				}
				for (let i in rng_array) {
					// check damage rolls
					if (rng_array[i][0] == damage_rolls['auron'][0] && 
						rng_array[i][1] == damage_rolls['tidus'][0] && 
						rng_array[i][2] == damage_rolls['auron'][1] && 
						rng_array[i][3] == damage_rolls['tidus'][1] && 
						rng_array[i][4] == damage_rolls['auron'][2] && 
						rng_array[i][5] == damage_rolls['tidus'][2]) {
						console.log('Seed found! Seed number ' + i)
						return rng_array[i]
					}
				}
				console.log('Seed not found!')
				document.getElementById('raw_data').innerHTML = 'Seed not found!'
				document.getElementById('full_data').innerHTML = 'Seed not found!'
			}
			function get_condition(raw_rng, initiative=false) {
				let condition_rng = raw_rng & 255;
				let condition = 2;
				let output = '';
				if (initiative) {
					condition_rng = condition_rng - 32 - 1;
				}
				if (condition_rng < 255 - 32) {
					if (condition_rng < 32) {
						condition = 1;
					} else {
						condition = 0;
					}
				}
				if (condition == 0) {
					output = '';
				} else if (condition == 1) {
					output = 'Preemptive';
				} else if (condition == 2) {
					output = 'Ambush';
				}
				return output;
			}
			function get_formation(raw_rng, zone) {
				let formation_number = raw_rng % formations_array[zone].length;
				return formations_array[zone][formation_number];
			}
			function get_raw_data(seed) {
				let raw_data = '';
				for (let i = 6; i < 506; i++) {
					let encounter = (i - 5).toString().padStart(3, ' ');
					raw_data = `${raw_data}${encounter} | Forced Encounter: ${get_condition(seed[i]).padEnd(10, ' ')} | Random Encounter: ${get_condition(seed[i + 1]).padEnd(10, ' ')}|\n`;
				}
				return raw_data;
			}
			async function print_data() {
				current_seed = get_current_seed(csv_to_array(await get_csv_file(raw_rng_file)));
				formations_array = get_formations_array(await get_csv_file(formations_file))
				document.getElementById('raw_data').innerHTML = get_raw_data(current_seed);
				get_data(current_seed);
				document.getElementById('sliders').style.display = 'block';
			}
			var rng_position = 0
			var encounter_counter = 0
			var full_data = ''
			// 'Nidhogg+Dark Element x2/Valaha+Epaaj' needs a padding of 1 space, so 37 total characters
			var padding = 37
			function add_forced_encounters(encounters, initiative=false) {
				for (let i in encounters) {
					encounter_counter = encounter_counter + 1
					let condition = get_condition(current_seed[rng_position + 6], initiative)
					full_data = `${full_data}${encounter_counter.toString().padStart(3, ' ')}: ${encounters[i].padEnd(padding, ' ')}${condition}\n`
					rng_position = rng_position + 1
				}
			}
			function add_optional_forced_encounters(encounter_name, initiative=false) {
				let encounters = document.getElementById(encounter_name).value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let condition = get_condition(current_seed[rng_position + 6], initiative)
					encounter_name = `${encounter_name} [${i + 1}]`
					full_data = `${full_data}${encounter_counter.toString().padStart(3, ' ')}: ${encounter_name.padEnd(padding, ' ')}${condition}\n`
					rng_position = rng_position + 1
				}
			}
			function add_random_encounters(zone, initiative=false) {
				let encounters = document.getElementById(zone).value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let formation = get_formation(current_seed[rng_position + 6], zone).padEnd(padding, ' ')
					let condition = get_condition(current_seed[rng_position + 6 + 1], initiative)
					let encounter_number = `${zone} [${i + 1}]`
					full_data = `${full_data}${encounter_counter.toString().padStart(3, ' ')}: ${encounter_number}\n   \`-${formation}${condition}\n`
					rng_position = rng_position + 2
				}
			}
			function add_cave_encounters(initiative=false) {
				let encounters = document.getElementById('Cave').value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let formation_white_zone = get_formation(current_seed[rng_position + 6], 'Cave (White Zone)')
					let formation_green_zone = get_formation(current_seed[rng_position + 6], 'Cave (Green Zone)')
					let formation = `${formation_white_zone}/${formation_green_zone}`.padEnd(padding, ' ')
					let condition = get_condition(current_seed[rng_position + 6 + 1], initiative)
					let encounter_number = `Cave [${i + 1}]`
					full_data = `${full_data}${encounter_counter.toString().padStart(3, ' ')}: ${encounter_number}\n   \`-${formation}${condition}\n`
					rng_position = rng_position + 2
				}
			}
			function get_data(seed) {
				add_forced_encounters(['Sinscales', 'Ammes', 'Tanker', 'Sahagins', 'Geosgaeno', 'Klikk 1', 'Klikk 2'])
				add_random_encounters('Underwater Ruins')
				add_forced_encounters(['Piranhas', 'Tros'])
				add_random_encounters('Besaid Lagoon')
				add_forced_encounters(['Dingo/Condor', 'Water Flan', 'Kimahri', 'Garuda 1', 'Garuda 2', 'Condor/Dingo/Water Flan'])
				add_random_encounters('Besaid')
				add_forced_encounters(['Sin Fin', 'Echuilles', 'Lancet tutorial'])
				add_optional_forced_encounters('Lord Ochu (Way In)')
				add_random_encounters('Kilika Woods (Way In)')
				add_forced_encounters(['Geneaux'])
				add_optional_forced_encounters('Lord Ochu (Way Out)')
				add_random_encounters('Kilika Woods (Way Out)')
				add_forced_encounters(['Machina 1', 'Machina 2', 'Machina 3', 'Oblitzerator', 'Sahagin Chiefs', 'Vouivre', 'Garuda', 'Pierce tutorial'])
				add_random_encounters('Miihen Screen 1')
				add_random_encounters('Miihen Screen 2/3')
				add_forced_encounters(['Chocobo Eater'])
				add_random_encounters('Old Road')
				add_random_encounters('Clasko Skip Screen')
				add_random_encounters('MRR - Valley')
				add_random_encounters('MRR - Precipice')
				add_forced_encounters(['Sinspawn Gui 1', 'Sinspawn Gui 2'])
				add_random_encounters('Djose Highroad (Front Half)', initiative=true)
				add_random_encounters('Djose Highroad (Back Half)', initiative=true)
				add_random_encounters('Moonflow (South)', initiative=true)
				add_forced_encounters(['Extractor', 'Rikku tutorial'])
				add_random_encounters('Moonflow (North)', initiative=true)
				add_random_encounters('Thunder Plains (South)', initiative=true)
				add_random_encounters('Thunder Plains (North)', initiative=true)
				add_random_encounters('Macalania Woods')
				add_forced_encounters(['Spherimorph'])
				add_random_encounters('Lake Macalania')
				add_forced_encounters(['Crawler', 'Seymour'])
				add_optional_forced_encounters('Guado Encounter')
				add_random_encounters('Crevasse')
				add_forced_encounters(['Wendigo', 'Zu'])
				add_random_encounters('Bikanel (Pre Machina)', initiative=true)
				add_forced_encounters(['Machina Steal tutorial'])
				add_random_encounters('Bikanel (Post Machina)', initiative=true)
				add_random_encounters('Bikanel (Central)', initiative=true)
				add_random_encounters('Bikanel (Ruins)', initiative=true)
				add_random_encounters('Bikanel (Pre Sandragora)', initiative=true)
				add_forced_encounters(['Sandragora 1'], initiative=true)
				add_optional_forced_encounters('Sandragora 1 refight', initiative=true)
				add_random_encounters('Bikanel (Post Sandragora)', initiative=true)
				add_forced_encounters(['Sandragora 2', 'Guado + 3 Bombs', 'Guado + 2 Dual Horn 1', 'Guado + 2 Chimera', 
					'Evrae', 'Bevelle Guards 1', 'Bevelle Guards 2', 'Bevelle Guards 3', 'Bevelle Guards 4', 'Bevelle Guards 5'], initiative=true)
				add_random_encounters('Via Purifico', initiative=true)
				add_forced_encounters(['Isaaru Grothia', 'Isaaru Pterya', 'Isaaru Spathi'])
				add_random_encounters('Via Purifico Underwater')
				add_forced_encounters(['Evrae Altana'])
				add_random_encounters('Highbridge', initiative=true)
				add_forced_encounters(['Seymour Natus'])
				add_random_encounters('Calm Lands', initiative=true)
				add_forced_encounters(['Defender X'])
				add_cave_encounters(initiative=true)
				full_data = full_data.replace(/Preemptive/g, '<span style="color:#00FF00">$&</span>')
				full_data = full_data.replace(/Ambush/g, '<span style="color:#FF0000">$&</span>')
				full_data = full_data.replace(/Ghost/g, '<mark>$&</mark>')
				full_data = full_data.replace(/Funguar/g, '<mark>$&</mark>')
				document.getElementById('full_data').innerHTML = full_data
				rng_position = 0
				encounter_counter = 0
				full_data = ''
			}
		</script>
		<title>ffx_seed_finder</title>
	</head>
	<body>
		<div style='display: grid; grid-template-columns: 1fr 100fr; column-gap: 4px;'>
			<button onclick='hide_raw_data()' id='raw_data_button' style='height:20px;width:120px'>Hide raw data</button>
			<script type='text/javascript'>
				function hide_raw_data() {
					let raw_data = document.getElementById('raw_data');
					let raw_data_button = document.getElementById('raw_data_button')
					if (raw_data.style.display === 'none') {
						raw_data.style.display = 'block';
						raw_data_button.innerHTML = 'Hide raw data'
					} else {
						raw_data.style.display = 'none';
						raw_data_button.innerHTML = 'Show raw data'
					}
				}
			</script>
			<form id='damage_rolls_form' onsubmit='print_data(); return false'>
				<label for='auron1'>Auron 1</label>
				<input type='number' id='auron1' name='auron1' min='260' max='588'>
				<label for='tidus1'>Tidus 1</label>
				<input type='number' id='tidus1' name='tidus1' min='125' max='282'>
				<label for='auron2'>Auron 2</label>
				<input type='number' id='auron2' name='auron2' min='260' max='588'>
				<label for='tidus2'>Tidus 2</label>
				<input type='number' id='tidus2' name='tidus2' min='125' max='282'>
				<label for='auron3'>Auron 3</label>
				<input type='number' id='auron3' name='auron3' min='260' max='588'>
				<label for='tidus3'>Tidus 3</label>
				<input type='number' id='tidus3' name='tidus3' min='125' max='282'>
				<input type='submit' value='Submit'>
			</form>
		</div>
		<div class='container'>
			<div>
				<pre id='raw_data'>Raw data goes here.</pre>
			</div>
			<div>
				<pre id='full_data'>Data goes here.</pre>
			</div>
			<div id='sliders' style="position: sticky; bottom: 20px; grid-row-start: 2; grid-column-start: 3; display: none;">
				<script type='text/javascript'>
					const sliders_array = {
						'Underwater Ruins':				{min:0, default:1, max:1},
						'Besaid Lagoon':				{min:0, default:2, max:4},
						'Besaid':						{min:0, default:0, max:1},
						'Lord Ochu (Way In)':			{min:0, default:0, max:1},
						'Kilika Woods (Way In)':		{min:0, default:2, max:6},
						'Lord Ochu (Way Out)':			{min:0, default:0, max:1},
						'Kilika Woods (Way Out)':		{min:0, default:4, max:6},
						'Miihen Screen 1':				{min:0, default:3, max:6},
						'Miihen Screen 2/3':			{min:0, default:6, max:10},
						'Old Road':						{min:0, default:3, max:8},
						'Clasko Skip Screen':			{min:0, default:2, max:3},
						'MRR - Valley':					{min:0, default:5, max:10},
						'MRR - Precipice':				{min:0, default:1, max:3},
						'Djose Highroad (Front Half)':	{min:0, default:1, max:3},
						'Djose Highroad (Back Half)':	{min:0, default:4, max:6},
						'Moonflow (South)':				{min:0, default:5, max:10},
						'Moonflow (North)':				{min:0, default:5, max:10},
						'Thunder Plains (South)':		{min:0, default:7, max:11},
						'Thunder Plains (North)':		{min:0, default:7, max:11},
						'Macalania Woods':				{min:0, default:7, max:10},
						'Lake Macalania':				{min:0, default:1, max:1},
						'Guado Encounter':				{min:0, default:0, max:2},
						'Crevasse':						{min:0, default:2, max:5},
						'Bikanel (Pre Machina)':		{min:0, default:3, max:5},
						'Bikanel (Post Machina)':		{min:0, default:1, max:5},
						'Bikanel (Central)':			{min:0, default:3, max:5},
						'Bikanel (Ruins)':				{min:0, default:0, max:5},
						'Bikanel (Pre Sandragora)':		{min:0, default:1, max:2},
						'Sandragora 1 refight':			{min:0, default:0, max:1},
						'Bikanel (Post Sandragora)':	{min:0, default:0, max:2},
						'Via Purifico':					{min:0, default:2, max:4},
						'Via Purifico Underwater':		{min:0, default:1, max:3},
						'Highbridge':					{min:0, default:2, max:5},
						'Calm Lands':					{min:0, default:10, max:12},
						'Cave':							{min:0, default:50, max:99}
					}
					const div = document.getElementById('sliders');
					for (let key in sliders_array) {
						sliders_array[key].parent = document.createElement('div');
						sliders_array[key].parent.id = key + ' Container';
						sliders_array[key].parent.style = 'display: grid; grid-template-columns: 1fr 1fr 100fr; height:24px;';
						sliders_array[key].counter = document.createElement('pre');
						sliders_array[key].counter.id = key + ' Counter';
						sliders_array[key].counter.innerHTML = `${sliders_array[key].default}`.padStart(2, ' ');
						sliders_array[key].slider = document.createElement('input');
						sliders_array[key].slider.type = 'range';
						sliders_array[key].slider.id = key;
						sliders_array[key].slider.min = sliders_array[key].min;
						sliders_array[key].slider.value = sliders_array[key].default;
						sliders_array[key].slider.max = sliders_array[key].max;
						sliders_array[key].slider.oninput = function () {get_data(current_seed); sliders_array[key].counter.innerHTML = this.value.padStart(2, ' ');};
						sliders_array[key].label = document.createElement('pre');
						sliders_array[key].label.innerHTML = key;
						div.appendChild(sliders_array[key].parent);
						sliders_array[key].parent.appendChild(sliders_array[key].counter);
						sliders_array[key].parent.appendChild(sliders_array[key].slider);
						sliders_array[key].parent.appendChild(sliders_array[key].label);
					}
				</script>
			</div>
		</div>
	</body>
</html>
