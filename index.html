<!doctype html>
<html>
	<head>
		<style type="text/css">
			.container {
				display: grid;
				grid-template-columns: 1fr 1fr 1fr 1fr 100fr;
				column-gap: 4px;
			}
		</style>
		<script>
			const raw_rng_file = 'https://gist.githubusercontent.com/Grayfox96/468e7a4ba63281208e07b476d45ccf3f/raw/d16cd4e02d08c7eda63ff191cc75b9923cc55ce4/ffxhd-raw-encounter-values.csv'
			const formations_file = 'https://gist.githubusercontent.com/Grayfox96/fe50cabfd264caeefdabe34507b86bce/raw/38a0aa30f58b6746bf4bcceefd7872d168095b34/ffxhd-formations.csv'
			var current_seed = []
			var formations_array = []
			async function get_csv_file(file) {
				response = await fetch(file);
				text = await response.text()
				return text
			}
			function csv_to_array(csv_text, delimiter = ',') {
				let array = []
				let rows = csv_text.split("\n");
				for (let i = 0; i < rows.length; i++) {
					array.push(rows[i].split(','));
				}
				return array
			}
			function get_formations_array(formations_text, delimiter=',') {
				let rows = formations_text.split("\n");
				let array = []
				for (let i = 0; i < rows.length; i++) {
					let row = rows[i].split(',')
					for (let j = 0; j < row.length;) {
						if (j == 0) {
							array[row[0]] = []
						} else {
							array[row[0]].push(row[j])
						}
						j++
					}
				}
				formations_array = array
				return array
			}
			function get_current_seed(rng_array){
				damage_rolls = []
				damage_rolls['auron'] = [document.forms.damage_rolls_form.elements[0].value, document.forms.damage_rolls_form.elements[2].value, document.forms.damage_rolls_form.elements[4].value]
				damage_rolls['tidus'] = [document.forms.damage_rolls_form.elements[1].value, document.forms.damage_rolls_form.elements[3].value, document.forms.damage_rolls_form.elements[5].value]
				for (let i = 0; i < 3;) {
					if (damage_rolls['auron'][i] > 294) {
						damage_rolls['auron'][i] = damage_rolls['auron'][i] / 2
					}
					if (damage_rolls['tidus'][i] > 141) {
						damage_rolls['tidus'][i] = damage_rolls['tidus'][i] / 2
					}
					i++
				}
				for (let i = 0; i < rng_array.length; i++) {
					// check damage rolls
					if (rng_array[i][0] == damage_rolls['auron'][0] && 
						rng_array[i][1] == damage_rolls['tidus'][0] && 
						rng_array[i][2] == damage_rolls['auron'][1] && 
						rng_array[i][3] == damage_rolls['tidus'][1] && 
						rng_array[i][4] == damage_rolls['auron'][2] && 
						rng_array[i][5] == damage_rolls['tidus'][2]) {
						console.log('Seed found! Seed number ' + i)
						current_seed = rng_array[i]
						return current_seed
					}
				}
				console.log('Seed not found!')
			}
			function get_condition(raw_rng, initiative=false) {
				let condition_rng = raw_rng & 255;
				let condition = 2;
				let output = '';
				if (initiative) {
					condition_rng = condition_rng - 32 - 1;
				}
				if (condition_rng < 255 - 32) {
					if (condition_rng < 32) {
						condition = 1;
					} else {
						condition = 0;
					}
				}
				if (condition == 0) {
					output = '          ';
				} else if (condition == 1) {
					output = 'Preemptive';
				} else if (condition == 2) {
					output = 'Ambush    ';
				}
				return output;
			}
			function get_formation(raw_rng, zone) {
				let formation_number = raw_rng % formations_array[zone].length;
				return formations_array[zone][formation_number];
			}
			async function get_raw_data(seed) {
				let raw_data = '';
				for (let i = 6; i < 506; i++) {
					let encounter = i - 5
					raw_data = raw_data.concat(encounter + ' | Forced Encounter: ' + get_condition(seed[i]) + ' | Random Encounter: ' + get_condition(seed[i + 1]) + '\n')
				}
				return raw_data
			}
			async function print_raw_data() {
				document.getElementById('raw_data').innerHTML = await get_raw_data(get_current_seed(csv_to_array(await get_csv_file(raw_rng_file))));
				get_formations_array(await get_csv_file(formations_file))
				get_data(current_seed);
			}
			var rng_position = 0
			var encounter_counter = 0
			var full_data = ''
			var conditions = ''
			function add_forced_encounters(encounters, initiative=false) {
				for (let i = 0; i < encounters.length; i++) {
					encounter_counter = encounter_counter + 1
					let condition = get_condition(current_seed[rng_position + 6], initiative)
					full_data = full_data + encounter_counter + ': ' + encounters[i] + '\n'
					conditions = conditions + condition + '\n'
					rng_position = rng_position + 1
				}
			}
			function add_optional_forced_encounters(encounter_name, initiative=false) {
				let encounters = document.getElementById(encounter_name).value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let condition = get_condition(current_seed[rng_position + 6], initiative)
					full_data = full_data + encounter_counter + ': ' + encounter_name + ' [' + (i + 1) + ']' + '\n'
					conditions = conditions + condition + '\n'
					rng_position = rng_position + 1
				}
			}
			function add_random_encounters(zone, initiative=false) {
				let encounters = document.getElementById(zone).value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let formation = get_formation(current_seed[rng_position + 6], zone)
					let condition = get_condition(current_seed[rng_position + 6 + 1], initiative)
					full_data = full_data + encounter_counter + ': ' + zone + ' [' + (i + 1) + ']\n   `-' + formation + '\n'
					conditions = conditions + '\n' + condition + '\n'
					rng_position = rng_position + 2
				}
			}
			function add_cave_encounters(initiative=false) {
				let encounters = document.getElementById('Cave').value
				for (let i = 0; i < encounters; i++) {
					encounter_counter = encounter_counter + 1
					let formation_white_zone = get_formation(current_seed[rng_position + 6], 'Cave (White Zone)')
					let formation_green_zone = get_formation(current_seed[rng_position + 6], 'Cave (Green Zone)')
					let condition = get_condition(current_seed[rng_position + 6 + 1], initiative)
					full_data = full_data + encounter_counter + ': ' + 'Cave' + ' [' + (i + 1) + ']\n   `-' + formation_white_zone + '/' + formation_green_zone + '\n'
					conditions = conditions + '\n' + condition + '\n'
					rng_position = rng_position + 2
				}
			}
			function get_data(seed) {
				add_forced_encounters(['Sinscales', 'Ammes', 'Tanker', 'Sahagins', 'Geosgaeno', 'Klikk 1', 'Klikk 2'])
				add_random_encounters("Underwater Ruins", initiative=false)
				add_forced_encounters(['Piranhas', 'Tros'])
				add_random_encounters('Besaid Lagoon')
				add_forced_encounters(['Dingo/Condor', 'Water Flan', 'Kimahri', 'Garuda 1', 'Garuda 2', 'Condor/Dingo/Water Flan'])
				add_random_encounters('Besaid')
				add_forced_encounters(['Sin Fin', 'Echuilles', 'Lancet tutorial'])
				add_optional_forced_encounters('Lord Ochu (Way In)')
				add_random_encounters('Kilika Woods (Way In)')
				add_forced_encounters(['Geneaux'])
				add_optional_forced_encounters('Lord Ochu (Way Out)')
				add_random_encounters('Kilika Woods (Way Out)')
				add_forced_encounters(['Machina 1', 'Machina 2', 'Machina 3', 'Oblitzerator', 'Sahagin Chiefs', 'Vouivre', 'Garuda', 'Pierce tutorial'])
				add_random_encounters('Miihen Screen 1')
				add_random_encounters('Miihen Screen 2/3')
				add_forced_encounters(['Chocobo Eater'])
				add_random_encounters('Old Road')
				add_random_encounters('Clasko Skip Screen')
				add_random_encounters('MRR - Valley')
				add_random_encounters('MRR - Precipice')
				add_forced_encounters(['Sinspawn Gui 1', 'Sinspawn Gui 2'])
				add_random_encounters('Djose Highroad (Front Half)', initiative=true)
				add_random_encounters('Djose Highroad (Back Half)', initiative=true)
				add_random_encounters('Moonflow (South)', initiative=true)
				add_forced_encounters(['Extractor', 'Rikku tutorial'])
				add_random_encounters('Moonflow (North)', initiative=true)
				add_random_encounters('Thunder Plains (South)', initiative=true)
				add_random_encounters('Thunder Plains (North)', initiative=true)
				add_random_encounters('Macalania Woods')
				add_forced_encounters(['Spherimorph'])
				add_random_encounters('Lake Macalania')
				add_forced_encounters(['Crawler', 'Seymour'])
				add_optional_forced_encounters('Guado Encounter')
				add_random_encounters('Crevasse')
				add_forced_encounters(['Wendigo', 'Zu'])
				add_random_encounters('Bikanel (Pre Machina)', initiative=true)
				add_forced_encounters(['Machina Steal tutorial'])
				add_random_encounters('Bikanel (Post Machina)', initiative=true)
				add_random_encounters('Bikanel (Central)', initiative=true)
				add_random_encounters('Bikanel (Ruins)', initiative=true)
				add_random_encounters('Bikanel (Pre Sandragora)', initiative=true)
				add_forced_encounters(['Sandragora 1'])
				add_optional_forced_encounters('Sandragora 1 refight', initiative=true)
				add_random_encounters('Bikanel (Post Sandragora)', initiative=true)
				add_forced_encounters(['Sandragora 2', 'Guado + 3 Bombs', 'Guado + 2 Dual Horn 1', 'Guado + 2 Chimera', 'Evrae', 'Bevelle Guards 1', 'Bevelle Guards 2', 'Bevelle Guards 3', 'Bevelle Guards 4', 'Bevelle Guards 5'])
				add_random_encounters('Via Purifico', initiative=true)
				add_forced_encounters(['Isaaru Grothia', 'Isaaru Pterya', 'Isaaru Spathi'])
				add_random_encounters('Via Purifico Underwater')
				add_forced_encounters(['Evrae Altana'])
				add_random_encounters('Highbridge', initiative=true)
				add_forced_encounters(['Seymour Natus'])
				add_random_encounters('Calm Lands', initiative=true)
				add_forced_encounters(['Defender X'])
				add_cave_encounters(initiative=true)
				document.getElementById('full_data').innerHTML = full_data
				document.getElementById('conditions').innerHTML = conditions
				rng_position = 0
				encounter_counter = 0
				full_data = ''
				conditions = ''
			}
		</script>
		<title>ffx_seed_finder</title>
	</head>
	<body>
		<div style="display: grid; grid-template-columns: 10fr 1fr 10fr; max-height:20px">
			<form id="damage_rolls_form" onsubmit="print_raw_data(); return false">
				<label for="auron1">Auron 1</label>
				<input type="number" id="auron1" name="auron1" min="260" max="588">
				<label for="tidus1">Tidus 1</label>
				<input type="number" id="tidus1" name="tidus1" min="125" max="282">
				<label for="auron2">Auron 2</label>
				<input type="number" id="auron2" name="auron2" min="260" max="588">
				<label for="tidus2">Tidus 2</label>
				<input type="number" id="tidus2" name="tidus2" min="125" max="282">
				<label for="auron3">Auron 3</label>
				<input type="number" id="auron3" name="auron3" min="260" max="588">
				<label for="tidus3">Tidus 3</label>
				<input type="number" id="tidus3" name="tidus3" min="125" max="282">
				<input type="submit" value="Submit">
			</form>
			<button onclick="hide_raw_data()" id='raw_data_button' style="height:20px;width:120px">Hide raw data</button>
			<script type="text/javascript">
				function hide_raw_data() {
					let raw_data = document.getElementById("raw_data");
					let raw_data_button = document.getElementById("raw_data_button")
					if (raw_data.style.display === "none") {
						raw_data.style.display = "block";
						raw_data_button.innerHTML = 'Hide raw data'
					} else {
						raw_data.style.display = "none";
						raw_data_button.innerHTML = 'Show raw data'
					}
				}
			</script>
		</div>
		<div class="container">
			<div>
				<pre id='raw_data'>Raw data goes here.</pre>
			</div>
			<div>
				<pre id='full_data'>Data goes here.</pre>
			</div>
			<div>
				<pre id='conditions'>Conditions go here.</pre>
			</div>
			<div id='Sliders' style="display: grid; grid-template-columns: 1fr 1fr 100fr; max-height:1px; white-space: nowrap;">
				<script type="text/javascript">
					const sliders_array = {
						'Underwater Ruins':				{min:0, default:1, max:1},
						'Besaid Lagoon':				{min:0, default:2, max:4},
						'Besaid':						{min:0, default:0, max:1},
						'Lord Ochu (Way In)':			{min:0, default:0, max:1},
						'Kilika Woods (Way In)':		{min:0, default:2, max:6},
						'Lord Ochu (Way Out)':			{min:0, default:0, max:1},
						'Kilika Woods (Way Out)':		{min:0, default:4, max:6},
						'Miihen Screen 1':				{min:0, default:3, max:6},
						'Miihen Screen 2/3':			{min:0, default:6, max:10},
						'Old Road':						{min:0, default:3, max:8},
						'Clasko Skip Screen':			{min:0, default:2, max:3},
						'MRR - Valley':					{min:0, default:5, max:10},
						'MRR - Precipice':				{min:0, default:1, max:3},
						'Djose Highroad (Front Half)':	{min:0, default:1, max:3},
						'Djose Highroad (Back Half)':	{min:0, default:4, max:6},
						'Moonflow (South)':				{min:0, default:5, max:10},
						'Moonflow (North)':				{min:0, default:5, max:10},
						'Thunder Plains (South)':		{min:0, default:7, max:11},
						'Thunder Plains (North)':		{min:0, default:7, max:11},
						'Macalania Woods':				{min:0, default:7, max:10},
						'Lake Macalania':				{min:0, default:1, max:1},
						'Guado Encounter':				{min:0, default:0, max:2},
						'Crevasse':						{min:0, default:2, max:5},
						'Bikanel (Pre Machina)':		{min:0, default:3, max:5},
						'Bikanel (Post Machina)':		{min:0, default:1, max:5},
						'Bikanel (Central)':			{min:0, default:3, max:5},
						'Bikanel (Ruins)':				{min:0, default:0, max:5},
						'Bikanel (Pre Sandragora)':		{min:0, default:1, max:2},
						'Sandragora 1 refight':			{min:0, default:0, max:1},
						'Bikanel (Post Sandragora)':	{min:0, default:0, max:2},
						'Via Purifico':					{min:0, default:2, max:4},
						'Via Purifico Underwater':		{min:0, default:1, max:3},
						'Highbridge':					{min:0, default:2, max:5},
						'Calm Lands':					{min:0, default:10, max:12},
						'Cave':							{min:0, default:50, max:100}
					}
					const parent = document.getElementById("Sliders")
					for (let i = 0; i < Object.keys(sliders_array).length;) {
						let key = Object.keys(sliders_array)[i];
						sliders_array[key].pre = document.createElement('pre');
						sliders_array[key].pre.id = key + ' Counter';
						sliders_array[key].pre.innerHTML = sliders_array[key].default;
						sliders_array[key].slider = document.createElement('input');
						sliders_array[key].slider.type = 'range';
						sliders_array[key].slider.class = 'slider';
						sliders_array[key].slider.id = key;
						sliders_array[key].slider.min = sliders_array[key].min;
						sliders_array[key].slider.value = sliders_array[key].default;
						sliders_array[key].slider.max = sliders_array[key].max;
						sliders_array[key].slider.oninput = function () {get_data(current_seed);sliders_array[key].pre.innerHTML = this.value;}
						sliders_array[key].label = document.createElement('label');
						sliders_array[key].label.for = key;
						sliders_array[key].label.innerHTML = key;
						parent.appendChild(sliders_array[key].pre);
						parent.appendChild(sliders_array[key].slider);
						parent.appendChild(sliders_array[key].label);
						i++;
					}
				</script>
			</div>
		</div>
	</body>
</html>
